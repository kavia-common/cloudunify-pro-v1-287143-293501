{"is_source_file": true, "format": "Python", "description": "This script orchestrates the ingestion of cloud resource data from XLSX files into a PostgreSQL database for CloudUnify Pro. It processes resource details, costs, and recommendations, performing upsert operations across various tables, and generates detailed markdown and JSON reports of the ingestion process.", "external_files": ["dotenv", "openpyxl"], "external_methods": ["load_dotenv", "load_workbook", "psycopg.connect", "pathlib.Path", "json.loads", "json.dumps"], "published": ["run"], "classes": [{"name": "TableCounts", "description": "Holds counts for inserted, updated, and skipped records for a specific table."}, {"name": "FileReport", "description": "Stores the result of processing an input file, including counts of affected rows for each target table."}], "methods": [{"name": "str _ensure_ssl_and_channel_binding(dsn: str)", "description": "Ensures the DSN has 'sslmode=require' and 'channel_binding=require' parameters, normalizes async URLs.", "scope": "", "scopeKind": ""}, {"name": "datetime _now_utc()", "description": "Returns the current UTC datetime.", "scope": "", "scopeKind": ""}, {"name": "bool _is_missing(v: Any)", "description": "Checks if a value is None, empty, or NaN.", "scope": "", "scopeKind": ""}, {"name": "str _snake(s: str)", "description": "Converts a string to snake_case by lowercasing and replacing spaces with underscores.", "scope": "", "scopeKind": ""}, {"name": "Optional[str] _provider_from_filename(name: str)", "description": "Infers the provider (aws, azure, gcp) from a filename.", "scope": "", "scopeKind": ""}, {"name": "Optional[str] _normalize_provider(v: Any)", "description": "Normalizes provider input strings to standardized lowercase provider names.", "scope": "", "scopeKind": ""}, {"name": "str _normalize_priority(v: Any)", "description": "Normalizes priority levels to a set of predefined values.", "scope": "", "scopeKind": ""}, {"name": "Optional[datetime] _parse_datetime(v: Any)", "description": "Parses datetime values from openpyxl cells or ISO strings, adding timezone info if missing.", "scope": "", "scopeKind": ""}, {"name": "Optional[Decimal] _to_decimal_or_none(v: Any)", "description": "Converts a value to Decimal if possible, or returns None.", "scope": "", "scopeKind": ""}, {"name": "Dict[str,str] _parse_tags(v: Any)", "description": "Parses tags from dict or comma-separated key:value string into a dictionary.", "scope": "", "scopeKind": ""}, {"name": "List[Dict[str,Any]] _read_xlsx_rows(path: Path)", "description": "Reads XLSX worksheet rows into a list of dicts with normalized header keys.", "scope": "", "scopeKind": ""}, {"name": "bool _table_exists(conn: psycopg.Connection, table: str)", "description": "Checks if a table exists in the database schema.", "scope": "", "scopeKind": ""}, {"name": "Tuple[str,bool] _upsert_org(conn: psycopg.Connection, name: str, slug: str)", "description": "Inserts or updates an organization by slug, returning its ID and whether it was inserted.", "scope": "", "scopeKind": ""}, {"name": "Tuple[str,bool] _upsert_cloud_account( conn: psycopg.Connection, *, organization_id: str, provider: str, account_external_id: str, account_name: str, )", "description": "Inserts or updates a cloud account linked to an organization.", "scope": "", "scopeKind": ""}, {"name": "str _stable_recommendation_uuid( organization_id: str, provider: str, recommendation_id: Any, row: Dict[str, Any] )", "description": "Generates a stable UUID for recommendations based on various identifiers to ensure idempotency.", "scope": "", "scopeKind": ""}, {"name": "Optional[str] _find_resource_internal_id( conn: psycopg.Connection, *, organization_id: str, provider: str, cloud_account_id: str, external_resource_id: str, )", "description": "Resolves the internal resource UUID from external identifiers and provider context.", "scope": "", "scopeKind": ""}, {"name": "FileReport _ingest_resources_xlsx( conn: psycopg.Connection, *, organization_id: str, provider: str, cloud_account_id: str, path: Path, has_resource_costs_daily: bool, )", "description": "Processes resource XLSX files, inserting/updating resources and costs, returning a report.", "scope": "", "scopeKind": ""}, {"name": "FileReport _ingest_recommendations_xlsx( conn: psycopg.Connection, *, organization_id: str, cloud_account_ids: Dict[str, str], path: Path, )", "description": "Processes recommendations XLSX files and inserts/updates recommendations, returning a report.", "scope": "", "scopeKind": ""}, {"name": "Dict[str,TableCounts] _sum_table_counts(reports: Iterable[FileReport])", "description": "Aggregates counts across multiple FileReports.", "scope": "", "scopeKind": ""}, {"name": "str _render_markdown_run_section( *, started_at: datetime, finished_at: datetime, database_url: str, org: Dict[str, Any], lookups: Dict[str, TableCounts], file_reports: List[FileReport], totals: Dict[str, TableCounts], datasets: Sequence[str], )", "description": "Renders a detailed markdown section summarizing the ingestion run, including per-file and total counts.", "scope": "", "scopeKind": ""}, {"name": "int run()", "description": "Main CLI entry point; orchestrates the ingestion process, including database setup, file processing, report generation, and summary output.", "scope": "", "scopeKind": ""}, {"name": "str _row(table: str, c: TableCounts)", "scope": "_render_markdown_run_section", "scopeKind": "function", "description": "unavailable"}, {"name": "None load_dotenv(*args: Any, **kwargs: Any)", "scope": "", "scopeKind": "", "description": "unavailable"}], "calls": ["load_dotenv", "load_workbook", "psycopg.connect", "Path.exists", "Path.read_text", "Path.write_text", "urlparse", "urlunparse", "parse_qsl", "json.loads", "json.dumps", "re.sub", "datetime.fromisoformat", "datetime.now", "uuid.UUID", "uuid.uuid5"], "search-terms": ["ingest_step2_2_to_2_5", "CloudUnify Pro", "xlsx ingestion", "PostgreSQL", "resource costs daily", "recommendations ingestion", "neon schema", "cloud resources", "resource UUIDs", "recommendation UUIDs", "xlsx processing", "database connection"], "state": 2, "file_id": 44, "knowledge_revision": 131, "git_revision": "87c86140d7d0315ed93a86da4e0fee32bd91471c", "revision_history": [{"129": "3f065c9d5471e043ec358da4fd501f435cc3cd8c"}, {"130": "89f40ff48ae524bd64073d16537712d5bcb17dba"}, {"131": "87c86140d7d0315ed93a86da4e0fee32bd91471c"}], "ctags": [{"_type": "tag", "name": "DATASET_CHOICES", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^DATASET_CHOICES: Tuple[str, ...] = (\"aws\", \"azure\", \"gcp\", \"recommendations\")$/", "language": "Python", "typeref": "typename:Tuple[str, ...]", "kind": "variable"}, {"_type": "tag", "name": "FileReport", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^class FileReport:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "NAMESPACE_RECOMMENDATION", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^NAMESPACE_RECOMMENDATION = uuid.UUID(\"1d4ab8e8-0d5e-4c1a-9a41-2a30f1a34a2c\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "PRIORITIES", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^PRIORITIES = {\"low\", \"medium\", \"high\", \"critical\"}$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "PROVIDERS", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^PROVIDERS: Tuple[str, ...] = (\"aws\", \"azure\", \"gcp\")$/", "language": "Python", "typeref": "typename:Tuple[str, ...]", "kind": "variable"}, {"_type": "tag", "name": "TableCounts", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^class TableCounts:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "_ensure_ssl_and_channel_binding", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _ensure_ssl_and_channel_binding(dsn: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(dsn: str)"}, {"_type": "tag", "name": "_find_resource_internal_id", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _find_resource_internal_id($/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "function", "signature": "( conn: psycopg.Connection, *, organization_id: str, provider: str, cloud_account_id: str, external_resource_id: str, )"}, {"_type": "tag", "name": "_ingest_recommendations_xlsx", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _ingest_recommendations_xlsx($/", "language": "Python", "typeref": "typename:FileReport", "kind": "function", "signature": "( conn: psycopg.Connection, *, organization_id: str, cloud_account_ids: Dict[str, str], path: Path, )"}, {"_type": "tag", "name": "_ingest_resources_xlsx", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _ingest_resources_xlsx($/", "language": "Python", "typeref": "typename:FileReport", "kind": "function", "signature": "( conn: psycopg.Connection, *, organization_id: str, provider: str, cloud_account_id: str, path: Path, has_resource_costs_daily: bool, )"}, {"_type": "tag", "name": "_is_missing", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _is_missing(v: Any) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(v: Any)"}, {"_type": "tag", "name": "_normalize_priority", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _normalize_priority(v: Any) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(v: Any)"}, {"_type": "tag", "name": "_normalize_provider", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _normalize_provider(v: Any) -> Optional[str]:$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "function", "signature": "(v: Any)"}, {"_type": "tag", "name": "_now_utc", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _now_utc() -> datetime:$/", "language": "Python", "typeref": "typename:datetime", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "_parse_datetime", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _parse_datetime(v: Any) -> Optional[datetime]:$/", "language": "Python", "typeref": "typename:Optional[datetime]", "kind": "function", "signature": "(v: Any)"}, {"_type": "tag", "name": "_parse_tags", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _parse_tags(v: Any) -> Dict[str, str]:$/", "language": "Python", "typeref": "typename:Dict[str,str]", "kind": "function", "signature": "(v: Any)"}, {"_type": "tag", "name": "_provider_from_filename", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _provider_from_filename(name: str) -> Optional[str]:$/", "language": "Python", "typeref": "typename:Optional[str]", "kind": "function", "signature": "(name: str)"}, {"_type": "tag", "name": "_read_xlsx_rows", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _read_xlsx_rows(path: Path) -> List[Dict[str, Any]]:$/", "language": "Python", "typeref": "typename:List[Dict[str,Any]]", "kind": "function", "signature": "(path: Path)"}, {"_type": "tag", "name": "_render_markdown_run_section", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _render_markdown_run_section($/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "( *, started_at: datetime, finished_at: datetime, database_url: str, org: Dict[str, Any], lookups: Dict[str, TableCounts], file_reports: List[FileReport], totals: Dict[str, TableCounts], datasets: Sequence[str], )"}, {"_type": "tag", "name": "_row", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^    def _row(table: str, c: TableCounts) -> str:$/", "file": true, "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(table: str, c: TableCounts)", "scope": "_render_markdown_run_section", "scopeKind": "function"}, {"_type": "tag", "name": "_snake", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _snake(s: str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "(s: str)"}, {"_type": "tag", "name": "_stable_recommendation_uuid", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _stable_recommendation_uuid($/", "language": "Python", "typeref": "typename:str", "kind": "function", "signature": "( organization_id: str, provider: str, recommendation_id: Any, row: Dict[str, Any] )"}, {"_type": "tag", "name": "_sum_table_counts", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _sum_table_counts(reports: Iterable[FileReport]) -> Dict[str, TableCounts]:$/", "language": "Python", "typeref": "typename:Dict[str,TableCounts]", "kind": "function", "signature": "(reports: Iterable[FileReport])"}, {"_type": "tag", "name": "_table_exists", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _table_exists(conn: psycopg.Connection, table: str) -> bool:$/", "language": "Python", "typeref": "typename:bool", "kind": "function", "signature": "(conn: psycopg.Connection, table: str)"}, {"_type": "tag", "name": "_to_decimal_or_none", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _to_decimal_or_none(v: Any) -> Optional[Decimal]:$/", "language": "Python", "typeref": "typename:Optional[Decimal]", "kind": "function", "signature": "(v: Any)"}, {"_type": "tag", "name": "_upsert_cloud_account", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _upsert_cloud_account($/", "language": "Python", "typeref": "typename:Tuple[str,bool]", "kind": "function", "signature": "( conn: psycopg.Connection, *, organization_id: str, provider: str, account_external_id: str, account_name: str, )"}, {"_type": "tag", "name": "_upsert_org", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def _upsert_org(conn: psycopg.Connection, name: str, slug: str) -> Tuple[str, bool]:$/", "language": "Python", "typeref": "typename:Tuple[str,bool]", "kind": "function", "signature": "(conn: psycopg.Connection, name: str, slug: str)"}, {"_type": "tag", "name": "inserted", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^    inserted: int = 0$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "TableCounts", "scopeKind": "class"}, {"_type": "tag", "name": "load_dotenv", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^    def load_dotenv(*args: Any, **kwargs: Any) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "function", "signature": "(*args: Any, **kwargs: Any)"}, {"_type": "tag", "name": "run", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^def run() -> int:$/", "language": "Python", "typeref": "typename:int", "kind": "function", "signature": "()"}, {"_type": "tag", "name": "skipped", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^    skipped: int = 0$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "TableCounts", "scopeKind": "class"}, {"_type": "tag", "name": "updated", "path": "/home/kavia/workspace/code-generation/cloudunify-pro-v1-287143-293501/BackendAPI/scripts/ingest_step2_2_to_2_5.py", "pattern": "/^    updated: int = 0$/", "language": "Python", "typeref": "typename:int", "kind": "variable", "scope": "TableCounts", "scopeKind": "class"}], "hash": "1fede0918a75167b67a70accef438298", "format-version": 4, "code-base-name": "BackendAPI", "filename": "BackendAPI/scripts/ingest_step2_2_to_2_5.py", "fields": [{"name": "Tuple[str, ...] DATASET_CHOICES", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "NAMESPACE_RECOMMENDATION = uuid.UUID(\"1d4ab8e8-0d5e-4c1a-9a41-2a30f1a34a2c\")", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "PRIORITIES = {\"low\", \"medium\", \"high\", \"critical\"}", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "Tuple[str, ...] PROVIDERS", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "int inserted", "scope": "TableCounts", "scopeKind": "class", "description": "unavailable"}, {"name": "int skipped", "scope": "TableCounts", "scopeKind": "class", "description": "unavailable"}, {"name": "int updated", "scope": "TableCounts", "scopeKind": "class", "description": "unavailable"}]}